{{- if eq .Values.frontend.service.type "LoadBalancer" }}
apiVersion: batch/v1
kind: Job
metadata:
  name: "{{ include "agentgpt.fullname" . }}-clb-ip-setup"
  labels:
    {{- include "agentgpt.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": post-install
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  template:
    metadata:
      labels:
        {{- include "agentgpt.selectorLabels" . | nindent 8 }}
        app: frontend
    spec:
      serviceAccountName: "{{ include "agentgpt.fullname" . }}-ip-updater"
      containers:
      - name: clb-ip-setup
        image: {{ .Values.job.kubectlImage | default "kubectl.image" }}
        command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "Waiting for LoadBalancer to get external IP for service {{ include "agentgpt.fullname" . }}-frontend..."
          EXTERNAL_IP=""
          for i in $(seq 1 30); do
            EXTERNAL_IP=$(kubectl get svc {{ include "agentgpt.fullname" . }}-frontend --namespace {{ .Release.Namespace }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || true)
            if [ -n "$EXTERNAL_IP" ]; then
              echo "Successfully found external IP: $EXTERNAL_IP"
              break
            fi
            echo "Still waiting for external IP... (Attempt $i/30)"
            sleep 10
          done

          if [ -z "$EXTERNAL_IP" ]; then
            echo "Error: Timed out waiting for external IP after 5 minutes."
            exit 1
          fi

          echo "Patching deployment {{ include "agentgpt.fullname" . }}-frontend with NEXTAUTH_URL=http://$EXTERNAL_IP:{{ .Values.frontend.service.port }}"
          kubectl patch deployment {{ include "agentgpt.fullname" . }}-frontend --namespace {{ .Release.Namespace }} \
            --type='strategic' \
            -p='{"spec":{"template":{"spec":{"containers":[{"name":"frontend","env":[{"name":"NEXTAUTH_URL","value":"http://'$EXTERNAL_IP':{{ .Values.frontend.service.port }}"}]}]}}}}'
          echo "Patch successful. Deployment will be updated with the new environment variable."
      restartPolicy: Never
  backoffLimit: 3
{{- end }}